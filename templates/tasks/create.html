{% extends 'layouts/app.html' %}
{% block title %}Add Task - {{ project.title }}{% endblock %}
{% block content %}
<div class="max-w-2xl">
  <h1 class="text-xl font-semibold text-white mb-4">Add Task to {{ project.title }}</h1>
  <form method="post" novalidate class="space-y-4">
    {{ form.hidden_tag() }}
    <div>
      <label class="block text-sm text-gray-300 mb-1">{{ form.title.label.text }}</label>
      {{ form.title(class='w-full px-3 py-2 rounded bg-white/5 border border-white/10 text-gray-200 placeholder-gray-500', placeholder='Task title') }}
    </div>
    <div>
      <label class="block text-sm text-gray-300 mb-1">{{ form.description.label.text }}</label>
      {{ form.description(class='w-full px-3 py-2 rounded bg-white/5 border border-white/10 text-gray-200 placeholder-gray-500', rows='3', placeholder='Describe the task') }}
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm text-gray-300 mb-1">{{ form.due_date.label.text }}</label>
        {{ form.due_date(class='w-full px-3 py-2 rounded bg-white/5 border border-white/10 text-gray-200') }}
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-1">{{ form.priority.label.text }}</label>
        {{ form.priority(class='w-full px-3 py-2 rounded bg-white/5 border border-white/10 text-gray-200') }}
      </div>
    </div>
    <div>
      <label class="block text-sm text-gray-300 mb-1">{{ form.estimated_hours.label.text }}</label>
      {{ form.estimated_hours(class='w-full px-3 py-2 rounded bg-white/5 border border-white/10 text-gray-200', placeholder='e.g. 4.0') }}
    </div>
    <div>
      <label class="block text-sm text-gray-300 mb-1">{{ form.assignees.label.text }}</label>
      {{ form.assignees(class='w-full px-3 py-2 rounded bg-white/5 border border-white/10 text-gray-200', multiple=True) }}
    </div>
    <div>
      <label class="block text-sm text-gray-300 mb-1">{{ form.dependencies.label.text }}</label>
      {{ form.dependencies(class='w-full px-3 py-2 rounded bg-white/5 border border-white/10 text-gray-200', multiple=True) }}
    </div>
    <div class="rounded border border-white/10 bg-white/5">
      <div class="px-3 py-2 text-xs uppercase text-gray-400 border-b border-white/10">Recommended Assignees</div>
      <div class="p-3 space-y-2" id="recBox">
        <div class="text-sm text-gray-400">Click the button to fetch top candidates.</div>
        <button type="button" id="fetchRecs" class="px-3 py-2 rounded border border-white/10 bg-white/5 text-white text-sm hover:bg-white/10">Show Recommendations</button>
        <div id="recList" class="text-sm text-gray-300"></div>
      </div>
    </div>
    <div>
      {{ form.submit(class='px-4 py-2 rounded border border-white/10 bg-accent/20 text-white text-sm hover:bg-accent/30') }}
    </div>
  </form>
</div>
{% endblock %}
{% block scripts %}
<script>
(function(){
  const btn = document.getElementById('fetchRecs');
  const list = document.getElementById('recList');
  const eh = document.querySelector('input[name="estimated_hours"]');
  const pr = document.querySelector('select[name="priority"]');
  btn?.addEventListener('click', async ()=>{
    list.textContent = 'Loading...';
    const params = new URLSearchParams();
    params.set('project_id', '{{ project.id }}');
    params.set('limit', '3');
    if (eh && eh.value) params.set('estimated_hours', eh.value);
    if (pr && pr.value) params.set('priority', pr.value);
    try {
      const r = await fetch('/api/recommendations?' + params.toString());
      const d = await r.json();
      if (!Array.isArray(d) || d.length === 0) { list.textContent = 'No suggestions.'; return; }
      list.innerHTML = d.map(x => `<div class=\"px-2 py-1 rounded border border-white/10 bg-black/30\">`+
        `<div><span class=\"text-white\">${x.username}</span> <span class=\"text-xs text-gray-400\">(workload ${x.current_workload || 0}%, ${x.availability})</span></div>`+
        (x.reason ? `<div class=\"text-xs text-gray-400\">${x.reason}</div>` : '')+
      `</div>`).join('');
    } catch(e){ list.textContent = 'Failed to fetch recommendations.'; }
  });
})();
</script>
{% endblock %}
